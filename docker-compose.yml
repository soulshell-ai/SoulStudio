services:

  comfyui:
    init: true
    container_name: comfyui
    image: "comfyui:dev"
    build:
      context: .
      dockerfile: Dockerfile.comfyui
    ports:
      - "8188:8188"
    volumes:
      - "./data/comfyui/storage:/root"
      - "./third_party/ComfyUI:/root/ComfyUI"
      - "./data/comfyui/storage-models/models:/root/ComfyUI/models"
      - "./data/comfyui/storage-models/hf-hub:/root/.cache/huggingface/hub"
      - "./data/comfyui/storage-models/torch-hub:/root/.cache/torch/hub"
      - "./data/comfyui/storage-user/input:/root/ComfyUI/input"
      - "./data/comfyui/storage-user/output:/root/ComfyUI/output"
      - "./data/comfyui/storage-user/workflows:/root/ComfyUI/user/default/workflows"
      - "./third_party/custom_nodes:/root/ComfyUI/custom_nodes"
      - "./data/custom_nodes/IndexTTS2/checkpoints:/root/ComfyUI/custom_nodes/IndexTTS2/checkpoints"
    environment:
      - CLI_ARGS=
    security_opt:
      # - "label=type:nvidia_container_t"
      - "label=disable"
      - "seccomp=unconfined"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ '0' ]
              capabilities: [ gpu ]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  pixelle-mcp:
    container_name: pixelle-mcp
    image: "pixelle-mcp:latest"
    build:
      context: ./third_party/Pixelle-MCP/
      dockerfile: Dockerfile
    ports:
      - "9004:9004"
    volumes:
      - ./data/pixelle-mcp/data:/app/data
      - ./docker_init/Pixelle-MCP/.env:/app/.env:ro
      - ./third_party/Pixelle-Video/workflows/selfhost:/app/data/custom_workflows
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9004/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  pixelle-video-api:
    build:
      context: ./third_party/Pixelle-Video/
      dockerfile: Dockerfile
      args:
        USE_CN_MIRROR: ${USE_CN_MIRROR:-true}
    container_name: pixelle-video-api
    command: .venv/bin/python api/app.py --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    volumes:
      - ./docker_init/Pixelle-Video/config.yaml:/app/config.yaml
      - ./data/pixelle-video/data:/app/data
      - ./data/pixelle-video/output:/app/output
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Web UI服务 - Streamlit前端
  pixelle-video-web:
    build:
      context: ./third_party/Pixelle-Video/
      dockerfile: Dockerfile
      args:
        USE_CN_MIRROR: ${USE_CN_MIRROR:-false}
    container_name: pixelle-video-web
    command: .venv/bin/streamlit run web/app.py --server.port 8501 --server.address 0.0.0.0
    ports:
      - "8501:8501"
    volumes:
      - ./docker_init/Pixelle-Video/config.yaml:/app/config.yaml
      - ./data/pixelle-video/data:/app/data
      - ./data/pixelle-video/output:/app/output
    environment:
      - TZ=Asia/Shanghai
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8501/_stcore/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
